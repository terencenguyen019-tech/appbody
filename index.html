<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Coach AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        /* Ẩn thanh cuộn cho gọn */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS SVG (Nhúng trực tiếp để không bị lỗi thư viện) ---
        const Icons = {
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
        };

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_key") || "");
            const [modelName, setModelName] = useState("gemini-1.5-flash");
            const [showSettings, setShowSettings] = useState(!apiKey);
            
            // App Logic đơn giản hóa cho tích hợp
            const [day, setDay] = useState(1);
            const [img, setImg] = useState(null);
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);

            useEffect(() => { if(apiKey) localStorage.setItem("gemini_key", apiKey); }, [apiKey]);

            const handleAnalyze = async () => {
                if(!apiKey) return setShowSettings(true);
                if(!img) return alert("Chưa có ảnh!");
                
                setLoading(true);
                try {
                    // Call API thật
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                    const base64Data = img.split(',')[1];
                    const mimeType = img.split(';')[0].split(':')[1];

                    const payload = {
                        contents: [{
                            parts: [
                                { text: `Bạn là PT Gym. Hãy phân tích body trong ảnh này. Đưa ra nhận xét ưu/nhược điểm và lời khuyên tập luyện ngắn gọn. Output JSON: {"score": number, "comment": string, "advice": string}` },
                                { inlineData: { mimeType: mimeType, data: base64Data } }
                            ]
                        }],
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    const req = await fetch(API_URL, {
                        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
                    });
                    
                    const res = await req.json();
                    if(!res.candidates) throw new Error("Lỗi API/Key");
                    const data = JSON.parse(res.candidates[0].content.parts[0].text);
                    setResult(data);
                } catch(e) {
                    alert("Lỗi: " + e.message);
                    if(e.message.includes("Key")) setShowSettings(true);
                } finally {
                    setLoading(false);
                }
            };

            const handleFile = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = () => setImg(r.result);
                    r.readAsDataURL(f);
                }
            }

            return (
                <div className="p-4 max-w-md mx-auto min-h-screen pb-20">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-indigo-600">Body Coach AI</h1>
                        <button onClick={() => setShowSettings(true)} className="p-2 bg-gray-100 rounded-full text-gray-600"><Icons.Settings/></button>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-xl w-full max-w-sm">
                                <h3 className="font-bold text-lg mb-4">Cấu hình AI</h3>
                                <input className="w-full border p-3 rounded mb-3" placeholder="Google API Key..." value={apiKey} onChange={e=>setApiKey(e.target.value)} />
                                <select className="w-full border p-3 rounded mb-4" value={modelName} onChange={e=>setModelName(e.target.value)}>
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Nhanh)</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (Thông minh)</option>
                                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Mới)</option>
                                </select>
                                <button onClick={()=>setShowSettings(false)} className="w-full bg-indigo-600 text-white p-3 rounded font-bold">Lưu & Đóng</button>
                            </div>
                        </div>
                    )}

                    {/* Main Interface */}
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                        <div className="flex justify-between mb-4">
                            <h2 className="font-bold text-gray-700">Check-in Ngày {day}</h2>
                            <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full font-bold">Cycle 1</span>
                        </div>

                        {!img ? (
                            <label className="block w-full aspect-[3/4] border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50">
                                <div className="text-gray-400 mb-2"><Icons.Upload/></div>
                                <span className="text-sm text-gray-500">Tải ảnh body</span>
                                <input type="file" className="hidden" onChange={handleFile} accept="image/*"/>
                            </label>
                        ) : (
                            <div className="relative rounded-xl overflow-hidden aspect-[3/4] bg-black">
                                <img src={img} className="w-full h-full object-contain"/>
                                <button onClick={()=>setImg(null)} className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full"><Icons.X/></button>
                            </div>
                        )}

                        <button onClick={handleAnalyze} disabled={!img || loading} className="w-full mt-4 bg-indigo-600 text-white p-3 rounded-xl font-bold flex items-center justify-center gap-2">
                            {loading ? "Đang phân tích..." : "Phân tích ngay"}
                        </button>
                    </div>

                    {/* Result */}
                    {result && (
                        <div className="bg-white rounded-2xl p-6 shadow-lg border-l-4 border-green-500 animate-fade-in">
                            <div className="flex items-center gap-4 mb-4">
                                <div className="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center text-2xl font-bold text-green-700 border-4 border-white shadow">
                                    {result.score}
                                </div>
                                <div>
                                    <p className="text-xs text-gray-500 uppercase font-bold">Điểm số Body</p>
                                    <p className="font-bold text-gray-800">Khá tốt!</p>
                                </div>
                            </div>
                            <div className="space-y-3">
                                <div className="bg-gray-50 p-3 rounded text-sm text-gray-700">
                                    <strong>Nhận xét:</strong> {result.comment}
                                </div>
                                <div className="bg-orange-50 p-3 rounded text-sm text-orange-800 border border-orange-100">
                                    <strong>Lời khuyên:</strong> {result.advice}
                                </div>
                            </div>
                            <button onClick={()=>{setResult(null); setImg(null); setDay(d=>d+1)}} className="w-full mt-4 text-indigo-600 font-bold text-sm">Qua ngày tiếp theo &rarr;</button>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
