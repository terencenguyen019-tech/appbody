import React, { useState, useMemo } from 'react';
import { Camera, Upload, ChevronRight, Brain, CheckCircle, Calendar, Target, Activity, X, Settings, Trash2, RefreshCw, AlertTriangle, TrendingUp, Dumbbell, Utensils, ScanEye } from 'lucide-react';


const BASE_URL = "https://generativelanguage.googleapis.com/v1beta";


// --- API & PROMPT ---


const fetchModelsFromGoogle = async (apiKey) => {
  try {
    const response = await fetch(`${BASE_URL}/models?key=${apiKey}`);
    if (!response.ok) throw new Error("Key lỗi.");
    const data = await response.json();
    return data.models
      .filter(m => m.supportedGenerationMethods.includes("generateContent") && (m.name.includes("flash") || m.name.includes("pro")))
      .map(m => ({ id: m.name.replace("models/", ""), name: m.displayName }))
      .sort((a, b) => {
        if (a.id.includes("2.5-flash")) return -1;
        return b.id.localeCompare(a.id);
      });
  } catch (error) { throw error; }
};


const callGeminiCoach = async (apiKey, modelName, photos, currentGoal, historyScores) => {
  const API_URL = `${BASE_URL}/models/${modelName}:generateContent?key=${apiKey}`;


  // Chỉ lấy ảnh Ngày đầu tiên và Ảnh Ngày cuối cùng để so sánh trực diện
  // Cộng thêm ảnh hôm nay để phân tích
  const firstPhoto = photos[0];
  const lastPhoto = photos[photos.length - 1];
 
  // Chuẩn bị dữ liệu ảnh gửi đi
  const imageParts = [firstPhoto, lastPhoto].map((p) => {
    const matches = p.url.match(/^data:(.+);base64,(.+)$/);
    return { inlineData: { mimeType: matches[1], data: matches[2] } };
  });


  const promptText = `
    Vai trò: Chuyên gia thể hình & Dinh dưỡng hàng đầu (Top-tier Bodybuilding Coach).
    Nhiệm vụ:
    1. So sánh ảnh ĐẦU TIÊN (Ngày ${firstPhoto.day}) và ảnh MỚI NHẤT (Ngày ${lastPhoto.day}).
    2. Đánh giá mục tiêu người dùng: "${currentGoal}".


    Yêu cầu Output JSON chính xác:
    {
      "current_score": (0-100, điểm số hiện tại của body),
      "trend_comment": (Nhận xét ngắn 1 câu về xu hướng: Đang đi lên hay đi xuống so với ngày đầu?),
      "visual_analysis": {
         "improvements": (Liệt kê 2 điểm đã cải thiện rõ rệt),
         "weaknesses": (AI hãy "soi" kỹ body: Nhóm cơ nào đang yếu/lép/lệch? Mỡ tập trung ở đâu? Nêu 2 khuyết điểm chí mạng cần sửa)
      },
      "action_plan": {
         "exercises": [
            (Tên 3 bài tập CỤ THỂ tốt nhất để khắc phục khuyết điểm trên hoặc phục vụ mục tiêu "${currentGoal}". Kèm số sets x reps. Ví dụ: "Barbell Curl: 3x12")
         ],
         "nutrition": [
            (Gợi ý 3 thực phẩm cụ thể nên ăn thêm/bớt. Ví dụ: "Ức gà: 200g/ngày", "Cắt giảm đường")
         ]
      }
    }
  `;


  const payload = {
    contents: [{ role: "user", parts: [{ text: promptText }, ...imageParts] }],
    safetySettings: [
      { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
      { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
      { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
    ],
    generationConfig: { responseMimeType: "application/json", temperature: 0.4 }
  };


  try {
    const response = await fetch(API_URL, {
      method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
    });
    const data = await response.json();
    if (!data.candidates) throw new Error("AI không phản hồi.");
    return JSON.parse(data.candidates[0].content.parts[0].text);
  } catch (error) { throw error; }
};


// --- CHART COMPONENT (SVG ĐƠN GIẢN) ---
const SimpleLineChart = ({ data }) => {
  if (data.length < 2) return <div className="text-xs text-gray-400 text-center h-20 flex items-center justify-center">Cần ít nhất 2 lần đo để vẽ biểu đồ</div>;
 
  const height = 100;
  const width = 300;
  const maxScore = 100;
 
  // Tính toán tọa độ điểm
  const points = data.map((score, index) => {
    const x = (index / (data.length - 1)) * width;
    const y = height - (score / maxScore) * height;
    return `${x},${y}`;
  }).join(' ');


  return (
    <div className="w-full bg-indigo-50 rounded-xl p-4 mb-4 border border-indigo-100">
      <div className="flex justify-between mb-2">
        <span className="text-xs font-bold text-indigo-700 uppercase flex gap-1"><TrendingUp size={14}/> Biểu đồ phong độ</span>
        <span className="text-xs font-bold text-indigo-500">Mới nhất: {data[data.length-1]}đ</span>
      </div>
      <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-24 overflow-visible">
        {/* Đường kẻ ngang mốc 50đ */}
        <line x1="0" y1={height/2} x2={width} y2={height/2} stroke="#cbd5e1" strokeDasharray="4" strokeWidth="1" />
        {/* Đường biểu đồ */}
        <polyline fill="none" stroke="#4f46e5" strokeWidth="3" points={points} />
        {/* Các điểm tròn */}
        {data.map((score, index) => {
           const x = (index / (data.length - 1)) * width;
           const y = height - (score / maxScore) * height;
           return <circle key={index} cx={x} cy={y} r="4" fill="#4f46e5" stroke="white" strokeWidth="2" />;
        })}
      </svg>
    </div>
  );
};


export default function ProCoachApp() {
  const [apiKey, setApiKey] = useState("");
  const [modelName, setModelName] = useState("");
  const [availableModels, setAvailableModels] = useState([]);
  const [showKeyInput, setShowKeyInput] = useState(true);
  const [isLoadingModels, setIsLoadingModels] = useState(false);


  const [currentDay, setCurrentDay] = useState(1);
  const [photos, setPhotos] = useState([]);
  const [goals, setGoals] = useState({});
  // Lưu lịch sử điểm số để vẽ biểu đồ: [70, 75, 72...]
  const [scoreHistory, setScoreHistory] = useState([]);
 
  const [tempImage, setTempImage] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [showReportModal, setShowReportModal] = useState(false);
  const [latestReport, setLatestReport] = useState(null);
  const [inputGoal, setInputGoal] = useState("");
  const [errorMsg, setErrorMsg] = useState("");


  const currentCycle = Math.ceil(currentDay / 3);
  const isStartOfCycle = (currentDay - 1) % 3 === 0;
  const isEndOfCycle = currentDay % 3 === 0;
  const hasPhotoToday = photos.some(p => p.day === currentDay);
  const currentCycleGoal = goals[currentCycle] || "";


  // Handlers
  const handleScanModels = async () => {
    if (apiKey.length < 10) return alert("Nhập Key trước!");
    setIsLoadingModels(true);
    try {
      const models = await fetchModelsFromGoogle(apiKey);
      setAvailableModels(models);
      if (models.length > 0) {
        const best = models.find(m => m.id.includes("2.5-flash")) || models[0];
        setModelName(best.id);
      }
    } catch (err) { setErrorMsg(err.message); }
    finally { setIsLoadingModels(false); }
  };


  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setTempImage(reader.result);
      reader.readAsDataURL(file);
    }
  };


  const saveDayData = () => {
    if (isStartOfCycle && !currentCycleGoal && !inputGoal) return alert("Nhập mục tiêu trước!");
    if (isStartOfCycle && !currentCycleGoal) setGoals(prev => ({ ...prev, [currentCycle]: inputGoal }));
    if (tempImage) {
      setPhotos([...photos, { day: currentDay, url: tempImage, cycle: currentCycle }]);
      setTempImage(null);
      setInputGoal("");
    }
  };


  const handleAnalyze = async () => {
    if (!apiKey) return setShowKeyInput(true);
    setIsAnalyzing(true);
    setErrorMsg("");
    try {
      const finalModel = modelName || "gemini-1.5-flash";
      const result = await callGeminiCoach(apiKey, finalModel, photos, currentCycleGoal, scoreHistory);
     
      const newReport = { day: currentDay, result: result };
      setLatestReport(newReport);
     
      // Cập nhật lịch sử điểm số
      setScoreHistory(prev => [...prev, result.current_score]);
     
      setShowReportModal(true);
    } catch (err) {
      setErrorMsg(err.message);
      if(err.message.includes("Key") || err.message.includes("404")) setShowKeyInput(true);
    } finally { setIsAnalyzing(false); }
  };


  const nextDay = () => {
    setCurrentDay(prev => prev + 1);
    setTempImage(null);
    setShowReportModal(false);
  };


  const resetApp = () => {
    if(confirm("Xóa toàn bộ dữ liệu?")) {
      setCurrentDay(1);
      setPhotos([]);
      setGoals({});
      setScoreHistory([]);
      setLatestReport(null);
    }
  };


  return (
    <div className="min-h-screen bg-gray-50 font-sans pb-10 max-w-md mx-auto shadow-2xl border-x border-gray-100 relative">
     
      {/* SETTINGS MODAL */}
      {showKeyInput && (
        <div className="absolute inset-0 z-[60] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
          <div className="bg-white rounded-2xl p-6 w-full max-w-sm animate-in zoom-in">
            <div className="flex justify-between mb-4">
              <h2 className="font-bold text-indigo-600">Cấu hình AI Coach</h2>
              {apiKey && <button onClick={() => setShowKeyInput(false)}><X className="text-gray-400"/></button>}
            </div>
            <input type="password" placeholder="API Key..." className="w-full p-3 border rounded mb-3 outline-none focus:ring-2" value={apiKey} onChange={e => setApiKey(e.target.value)}/>
            <div className="flex gap-2 mb-4">
               <select className="flex-1 p-3 border rounded bg-white text-sm" value={modelName} onChange={e => setModelName(e.target.value)}>
                 {availableModels.length > 0 ? availableModels.map(m => <option key={m.id} value={m.id}>{m.id}</option>) : <option value="gemini-2.5-flash">Default (2.5-flash)</option>}
               </select>
               <button onClick={handleScanModels} className="bg-indigo-100 p-3 rounded text-indigo-700">{isLoadingModels ? "..." : <RefreshCw size={18}/>}</button>
            </div>
            <button onClick={() => setShowKeyInput(false)} className="w-full bg-indigo-600 text-white p-3 rounded font-bold">Bắt đầu Training</button>
          </div>
        </div>
      )}


      {/* HEADER */}
      <header className="bg-gradient-to-r from-gray-900 to-indigo-900 text-white p-6 rounded-b-3xl shadow-lg">
        <div className="flex justify-between items-start mb-4">
          <Settings size={20} className="text-green-400 cursor-pointer" onClick={() => setShowKeyInput(true)}/>
          <div className="text-right">
            <p className="text-indigo-200 text-xs">Chu kỳ</p>
            <p className="text-3xl font-bold">#{currentCycle}</p>
          </div>
        </div>
        <p className="text-indigo-200 text-sm">Hôm nay</p>
        <h1 className="text-4xl font-bold">Ngày {currentDay}</h1>
      </header>


      <main className="px-5 py-6 space-y-6">
        {/* INPUT GOAL */}
        {isStartOfCycle && !hasPhotoToday && (
          <div className="bg-white p-5 rounded-2xl shadow-sm border border-indigo-100 ring-4 ring-indigo-50 animate-in fade-in slide-in-from-bottom-4">
            <h2 className="font-bold text-indigo-700 mb-2 flex gap-2"><Target size={20}/> Mục tiêu giai đoạn này</h2>
            <textarea className="w-full p-3 bg-gray-50 border rounded-xl outline-none" rows="2" placeholder="VD: Muốn tay to hơn, ngực nở hơn..." value={inputGoal} onChange={e => setInputGoal(e.target.value)}></textarea>
          </div>
        )}


        {/* UPLOAD */}
        {!hasPhotoToday ? (
          <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <h2 className="font-bold text-gray-800 mb-4 flex gap-2"><Camera className="text-indigo-600"/> Check-in Body</h2>
            {!tempImage ? (
              <label className="block w-full aspect-[3/4] rounded-xl border-2 border-dashed border-gray-300 hover:border-indigo-500 bg-gray-50 flex flex-col items-center justify-center cursor-pointer">
                <Upload size={32} className="text-gray-400 mb-2"/>
                <span className="text-sm text-gray-500">Chụp ảnh (Thấy rõ cơ bắp)</span>
                <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload}/>
              </label>
            ) : (
              <div className="space-y-4">
                <div className="relative rounded-xl overflow-hidden aspect-[3/4] bg-black">
                  <img src={tempImage} className="w-full h-full object-contain"/>
                  <button onClick={() => setTempImage(null)} className="absolute top-2 right-2 p-2 bg-black/50 text-white rounded-full"><X size={16}/></button>
                </div>
                <button onClick={saveDayData} className="w-full py-3 rounded-xl font-bold text-white bg-indigo-600 shadow-lg flex justify-center gap-2"><CheckCircle/> Lưu Ảnh</button>
              </div>
            )}
          </div>
        ) : (
          <div className="bg-green-50 p-6 rounded-2xl border border-green-100 text-center">
            <CheckCircle size={40} className="text-green-600 mx-auto mb-3"/>
            <h3 className="font-bold text-green-800">Đã Check-in</h3>
            {isEndOfCycle && (
              <button onClick={handleAnalyze} disabled={isAnalyzing} className="w-full mt-4 text-white py-3 rounded-xl font-bold bg-indigo-600 shadow-md flex justify-center gap-2">
                {isAnalyzing ? "AI đang phân tích..." : `Audit Body & So sánh`}
                {!isAnalyzing && <ScanEye size={20}/>}
              </button>
            )}
          </div>
        )}


        {/* GALLERY GRID */}
        <div className="grid grid-cols-3 gap-2">
           {photos.map((p, i) => (
             <div key={i} className="relative aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
               <img src={p.url} className="w-full h-full object-cover"/>
               <div className="absolute bottom-0 inset-x-0 bg-black/60 p-1 text-[10px] text-center text-white">Ngày {p.day}</div>
             </div>
           ))}
        </div>


        {/* CONTROLS */}
        <div className="flex justify-center gap-2 mt-8 opacity-40 hover:opacity-100">
           <button onClick={nextDay} className="px-3 py-1 bg-gray-200 rounded text-xs font-bold">Skip Day</button>
           <button onClick={resetApp} className="px-3 py-1 bg-red-100 text-red-600 rounded text-xs font-bold">Reset</button>
        </div>
      </main>


      {/* --- PRO COACH REPORT MODAL --- */}
      {showReportModal && latestReport && (
        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex justify-center items-end sm:items-center">
          <div className="bg-gray-50 w-full sm:max-w-md h-[95vh] sm:h-[90vh] rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-in slide-in-from-bottom-10">
           
            {/* Header */}
            <div className="bg-indigo-700 p-4 text-white text-center shrink-0 relative z-10 shadow-md">
              <h2 className="text-lg font-bold uppercase flex items-center justify-center gap-2"><Brain size={20}/> Coach AI Analysis</h2>
              <button onClick={() => setShowReportModal(false)} className="absolute top-4 right-4"><X size={20}/></button>
            </div>


            {/* Content (Scrollable) */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 overscroll-contain">
             
              {/* 1. CHART */}
              <SimpleLineChart data={scoreHistory} />


              {/* 2. COMPARISON (BEFORE VS AFTER) */}
              <div className="bg-white rounded-xl p-3 shadow-sm">
                <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">So sánh thực tế (Ngày 1 vs Nay)</h3>
                <div className="grid grid-cols-2 gap-2">
                   <div className="relative aspect-[3/4] bg-gray-200 rounded overflow-hidden">
                      <img src={photos[0].url} className="w-full h-full object-cover" />
                      <span className="absolute bottom-1 left-1 bg-black/50 text-white text-[10px] px-1 rounded">Ngày 1</span>
                   </div>
                   <div className="relative aspect-[3/4] bg-gray-200 rounded overflow-hidden border-2 border-indigo-500">
                      <img src={photos[photos.length-1].url} className="w-full h-full object-cover" />
                      <span className="absolute bottom-1 left-1 bg-indigo-600 text-white text-[10px] px-1 rounded">Mới nhất</span>
                   </div>
                </div>
                <p className="text-xs text-gray-600 mt-2 italic text-center">"{latestReport.result.trend_comment}"</p>
              </div>


              {/* 3. VISUAL ANALYSIS (WEAKNESSES) */}
              <div className="bg-white rounded-xl p-4 shadow-sm border-l-4 border-red-500">
                <h3 className="text-sm font-bold text-red-600 flex items-center gap-2 mb-3">
                  <AlertTriangle size={16}/> Phân tích khuyết điểm (Audit)
                </h3>
                <div className="space-y-2">
                  <div className="text-sm">
                     <span className="font-bold text-gray-700">Điểm yếu cần sửa:</span>
                     <p className="text-gray-600 text-xs mt-1">{latestReport.result.visual_analysis.weaknesses}</p>
                  </div>
                   <div className="text-sm border-t border-gray-100 pt-2">
                     <span className="font-bold text-green-700">Điểm đã cải thiện:</span>
                     <p className="text-gray-600 text-xs mt-1">{latestReport.result.visual_analysis.improvements}</p>
                  </div>
                </div>
              </div>


              {/* 4. HYPER-SPECIFIC PLAN */}
              <div className="grid grid-cols-1 gap-3">
                {/* Workout */}
                <div className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                  <h3 className="text-sm font-bold text-blue-800 flex items-center gap-2 mb-2">
                    <Dumbbell size={16}/> Bài tập khắc phục
                  </h3>
                  <ul className="list-disc list-inside text-xs text-blue-900 space-y-1">
                    {latestReport.result.action_plan.exercises.map((ex, i) => (
                      <li key={i} className="font-medium">{ex}</li>
                    ))}
                  </ul>
                </div>


                {/* Nutrition */}
                <div className="bg-orange-50 rounded-xl p-4 border border-orange-100">
                  <h3 className="text-sm font-bold text-orange-800 flex items-center gap-2 mb-2">
                    <Utensils size={16}/> Dinh dưỡng tối ưu
                  </h3>
                  <ul className="list-disc list-inside text-xs text-orange-900 space-y-1">
                     {latestReport.result.action_plan.nutrition.map((nut, i) => (
                      <li key={i} className="font-medium">{nut}</li>
                    ))}
                  </ul>
                </div>
              </div>
             
              <div className="h-10"></div>
            </div>


            {/* Footer */}
            <div className="p-4 bg-white border-t border-gray-200 shrink-0 relative z-10">
              <button onClick={nextDay} className="w-full py-3 bg-indigo-700 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-800 flex items-center justify-center gap-2">
                Tiếp tục chu kỳ mới <ChevronRight size={18}/>
              </button>
            </div>
          </div>
        </div>
      )}


    </div>
  );
}

